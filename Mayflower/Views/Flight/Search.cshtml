@model Alphareds.Module.Model.FlightBookingModel
@using Alphareds.Module.Common;

@{
    ViewBag.Title = "Flight Search Result";
    ViewBag.HeaderRed = true;
    ViewBag.CheckSession = true;
    ViewBag.UsePopupLoginBox = true;
    string fixedres_css = Model.SearchFlightResultViewModel.IsFixedPrice ? "fixedresult-content" : "";
    string tripid = Request.QueryString["tripid"];
}

@section style{
    <link rel="stylesheet" href="@Url.Content("~/CSS/v2style.css")" type="text/css" />
    <link rel="stylesheet" href="@Url.Content("~/CSS/v2responsive.css")" type="text/css" />
    <link rel="stylesheet" class="slidercss" href="@Url.Content("~/CSS/sliders.css")" type="text/css" async />
    <link rel="stylesheet" class="slidercss" href="@Url.Content("~/CSS/price_slider.css")" type="text/css" async />
    <link rel="stylesheet" href="@Url.Content("~/CSS/ars-ui-autocomplete.css")" type="text/css" async />

    <!-- Slider jquery.ui Customize Start -->
    <style>
        /*for paging styling start*/
        .pagination > li > a, .pagination > li > span {
            position: unset !important;
            float: none !important;
            padding: unset !important;
            color: black !important;
            background-color: unset !important;
            border: none !important;
        }

        .pagination > .active > a {
            color: white !important;
        }
        /*for paging styling end*/
        .f2_mhdb3_promo {
            background-color: #040BF4;
            color: #FFF11A;
            height: 20px;
            width: 174px;
            padding-left: 28px;
            padding-top: 0;
            /* float: right; */
            border-radius: 12px;
            font-size: 14px;
            display: inline-block;
        }

        .s2_img_container {
            text-align: center;
            margin: 1%;
        }

        .flight_form_container1 {
            padding-left: 0px !important;
        }

        .tabsformobile4 {
            background-position: 20px center, right center;
        }

        .s2_main_container {
            max-width: 1210px;
            margin: auto;
            margin-top: 2%;
            margin-bottom: 2%;
            width: 96%;
        }

        .footer {
            margin-top: 0px;
        }

        .widget-footer2 {
            background-color: #fc950d !important;
            color: #fff;
        }

        .sorting-part {
            margin: auto;
            max-width: 1210px;
            width: 96%;
        }

        .s2_fil_in_right {
            width: 27%;
            float: right !important;
        }

        .s2_sf_left, .s2_sf_mid, .s2_sf_right {
            border-bottom: none;
        }

        input:focus {
            border-color: none !important;
            outline: 0 !important;
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
        }

        .reset-filter {
            text-decoration: none;
            /*color: #565656;*/
            color: #e61c1f;
            font-family: 'UbuntuMedium';
        }

        .ffc2_r2_b5 .yellow_toll_tip {
            right: 15px;
        }

        #slider-range {
            width: 90%;
        }

        #price-filter .ui-state-default, #price-filter .ui-widget-content #price-filter .ui-state-default, #price-filter .ui-widget-header #price-filter .ui-state-default {
            text-align: center !important;
            background-image: none !important;
            background-color: #f5930c !important;
            border: 0px !important;
        }

        .ui-slider.ui-corner-all.ui-slider-horizontal.ui-widget.ui-widget-content {
            border: inherit;
            background-color: inherit;
        }

        .s2_pf_right .ui-widget-content {
            background: none !important;
            border: 0px !important;
            border-bottom: 3px solid #666 !important;
            height: 7px;
        }

        .s2_ibinr_txtbox {
            background: transparent;
        }

        .checkbox-custom-label.add-cursor-pointer {
            margin-bottom: 0 !important;
            margin-top: 2px;
        }

        .tabs_content_container {
            padding-left: 5%;
            padding-right: 5%;
        }

        .mswi_searchleft {
            text-align: left;
            width: initial;
            margin-bottom: 3%;
            display: block;
        }

        .mswi_searchright {
            float: right;
        }

        .modifysearch_white1nn {
            overflow: initial;
            height: auto;
        }

        .ffc1spwidth, .ffc1spwidth1, .ffc1spwidth2 {
            text-align: left;
            padding-left: 0px;
            width: 44px;
        }

        .flight_form_container2 {
            padding-left: 0px !important;
        }

        .ffc2_r2_b2 {
            margin-left: -10px;
        }

        .ffc2_r3_b1 {
            text-align: left;
        }

        .ffc2_r1_b3 {
            margin-left: 10%;
        }

        .s2_mil_left {
            padding-left: 0px;
        }

            .s2_mil_left input[type=radio] {
                visibility: hidden;
            }

                .s2_mil_left input[type=radio]:not(old) + span {
                    display: inline-block;
                    width: 27px;
                    height: 27px;
                    margin: 0.25em 0.5em 0.25em 0.25em;
                    border: 0.0625em solid rgb(192,192,192);
                    border-radius: 24px;
                    background-image: -moz-linear-gradient(rgb(240,240,240),rgb(224,224,224));
                    background-image: -ms-linear-gradient(rgb(240,240,240),rgb(224,224,224));
                    background-image: -o-linear-gradient(rgb(240,240,240),rgb(224,224,224));
                    background-image: -webkit-linear-gradient(rgb(240,240,240),rgb(224,224,224));
                    background-image: linear-gradient(rgb(240,240,240),rgb(224,224,224));
                    vertical-align: bottom;
                }

                .s2_mil_left input[type=radio]:not(old):checked + span {
                    background-image: -moz-linear-gradient(rgb(224,224,224),rgb(240,240,240));
                    background-image: -ms-linear-gradient(rgb(224,224,224),rgb(240,240,240));
                    background-image: -o-linear-gradient(rgb(224,224,224),rgb(240,240,240));
                    background-image: -webkit-linear-gradient(rgb(224,224,224),rgb(240,240,240));
                    background-image: linear-gradient(rgb(224,224,224),rgb(240,240,240));
                }

                    .s2_mil_left input[type=radio]:not(old):checked + span > span {
                        display: block;
                        width: 15px;
                        height: 15px;
                        margin: 5px;
                        border-radius: 12px;
                        background: rgb(153,204,102);
                        background-image: -moz-linear-gradient(rgb(235,28,36),rgb(235,28,36));
                        background-image: -ms-linear-gradient(rgb(235,28,36),rgb(235,28,36));
                        background-image: -o-linear-gradient(rgb(235,28,36),rgb(235,28,36));
                        background-image: -webkit-linear-gradient(rgb(235,28,36),rgb(235,28,36));
                        background-image: linear-gradient(rgb(235,28,36),rgb(235,28,36));
                    }

        .not-pairable {
            background: rgba(168,168,168,0.9);
            position: absolute;
            left: 0;
            right: 0;
            top: -28px;
            bottom: 0;
            margin: auto;
            z-index: 500;
            text-align: center;
            line-height: 5;
            font-size: 2em;
        }

            .not-pairable span {
                -ms-transform: rotate(7deg);
                -webkit-transform: rotate(7deg);
                transform: rotate(7deg);
                display: inherit;
            }

        .isInvalid .s2_mcbmlid_dc_right > .showdetails {
            -webkit-filter: brightness(20);
            filter: brightness(20);
        }

        .isInvalid .s2_mcbml_inner_detail_container {
            background-color: #808080;
            -webkit-transition: background-color 300ms linear;
            -moz-transition: background-color 300ms linear;
            -o-transition: background-color 300ms linear;
            -ms-transition: background-color 300ms linear;
            transition: background-color 300ms linear;
        }

        .isInvalid input + span {
            background-image: url(../Images/stop-sig-re.png) !important;
            background-size: 24px !important;
            background-repeat: no-repeat !important;
            border: none !important;
        }

        .isInvalid .s2_mcbml_inner_detail_container .righttext, .isInvalid .s2_mcbml_inner_detail_container .showdetails {
            color: white;
        }

        .isInvalid .s2_mcbml_inner_detail_container img {
            -webkit-filter: brightness(10);
            filter: brightness(10);
        }

        .s2_mcb_io_left, .s2_mcb_io_right {
            color: #fff;
        }

            .s2_mcb_io_left span {
                display: none;
            }

            .s2_mcb_io_right span {
                display: none;
            }

        .s2_mcbcl_icon img {
            max-height: 40px;
            width: auto;
        }

        .s2_mil_l_ico img {
            max-height: 37px;
            width: auto;
        }

        .fillter_tags:empty {
            display: none;
        }

        .fillter_tags {
            cursor: pointer;
            margin-bottom: 0px;
        }

        /*.flight-filter-panel {
            padding-bottom: 30px;
        }*/

        .s3_1_fdb_i3_da_timing, .date_L, .s2span_leftgap {
            font-family: 'Conv_Ubuntu-Light';
            color: #000;
            background-image: none;
            padding-left: 0;
        }

        .s3_1_fdb_i3_da_lable .dep, .s3_1_fdb_i3_da_lable .ret {
            background-image: none;
            padding: 0px;
        }

        .show_more_flight_icon1 {
            margin-top: -22px !important;
        }

        .hidefilter_icon {
            margin-top: -23px !important;
        }

        #infantremindertext {
            display: none;
            font-size: 12px;
            text-align: left;
        }

        @@media screen and (min-width:901px) and (max-width : 1130px) {
            .s2_fil_in_right select {
                font-size: 14px;
            }
        }

        @@media screen and (min-width:901px) {
            .s3_1_fdb_child_det {
                margin-top: 0px;
            }

            .s2_mcb_ml_left_container {
                display: block !important;
            }

            .s2_mcb_ml_right_container {
                display: block !important;
            }

            .planeIcone {
                background-image: url('../../Images/fl_t_ico.png');
                background-repeat: no-repeat;
                padding-left: 50px;
            }

            .s2_ml_20 {
                margin-top: 7px;
            }

            .s3_1_fdb_inner_b3, .s3_1_fdb_i3_da_lable {
                width: 30%;
            }

            .s3_1_fdb_inner_b4 {
                width: 25%;
            }

            .s3_1_fdb_i3_da_timing {
                width: 70%;
            }

            .s2span_leftgap {
                padding-left: 0px;
            }

            .s3_1_fdb_i3_inner {
                max-width: 300px;
                margin: 0;
                margin-left: 10px;
            }

            .s3_1_fdb_modify_icon, .s3_1_fdb_child_det {
                float: right;
            }

            .s3_1_fdb4_inner {
                margin-right: 0px;
            }
        }

        @@media screen and (max-width: 900px) {

            .fthl_inner, .filter_timer_half_right {
                width: 90% !important;
                margin: 0 auto !important;
            }

            .s2_mcbcl_text {
                line-height: unset;
            }

            #cssmenu #menu-button:after {
                height: 4px; /*!important*/
            }

            .s2_ibinrl_b1, .s2_ibinrl_b3 {
                display: block;
            }

            .s2_ibinrl_b2, .s2_ibinrl_b4 {
                width: 39%;
            }

            .s2_ib_inr_left {
                width: 66%;
            }

            .s2_ib_inr_right {
                width: 34%;
            }

            .s2_mcb_io_left span, .s2_mcb_io_right span {
                font-size: 16px;
                display: flex !important;
                padding-top: 6px;
            }

            .outbound_click, .inbound_click {
                background-image: url(../images/tab_arrowdown_w.png);
                background-repeat: no-repeat;
                background-position: 97% 33px;
            }

            .boundarrow {
                background-image: url(../images/tab_arrowup_w.png);
            }

            .s2_mil_l_ico {
                float: left;
            }

            .s2_mil_l_text {
                float: left;
                padding-left: 10px;
                padding-top: 5px;
            }

            .s2_mil_left {
                width: 88px;
                margin-top: 0;
            }

            .s2_mil_right {
                width: 60%;
            }

            .xs-hidden {
                display: none;
            }

            .optiondura {
                text-align: right;
                padding-top: 5px;
                color: #616161;
                padding-right: 12px;
            }

            .s2_mcbml_inner_right {
                width: 33%;
                float: right;
                margin-top: 0;
            }

            .optiondura > span.s2_spredcolor {
                padding-right: 4px;
            }

            .s2_mcbml_ir_left, .s2_mcbml_ir_right {
                font-size: 22px;
            }
        }

        @@media screen and (min-width: 901px) {
            .optiondura {
                display: none;
            }
        }

        @@media screen and (max-width: 800px) {
            .tabs_content_container {
                padding-left: 5%;
                padding-right: 5%;
            }

            .s2_mcbml_inner_right {
                width: 38%;
            }

            .s2_mcbml_ir_mid {
                width: 28%;
            }

            .s2_mcbml_ir_right {
                width: 44%;
            }
        }

        @@media screen and (max-width: 700px) {
            .s2_mcbml_inner_right {
                width: 42%;
            }
        }

        @@media screen and (max-width: 620px) {
            .modifysearch_left_box, .modifysearch_right_box {
                float: none;
                width: 100%;
            }

            /*.s3_1_fdb_i3_da_lable .dep, .s3_1_fdb_i3_da_lable .ret {
                text-decoration: underline;
        }*/

            /*.s3_1_fdb_modify_icon {
                padding-left: 0px;
            }*/
        }

        @@media only screen and (min-device-width : 375px) and (max-device-width : 667px) and (orientation : landscape) { /* iphone6 landscape */
            .mswi_searchleft {
                margin-bottom: 2%;
            }

            .flight_form_container1 {
                margin-top: 10px;
            }

            .mswi_withflying_right {
                margin-top: -30px;
            }

            .flight_form_container2 {
                padding-left: 0px !important;
            }
        }

        @@media screen and (max-width: 625px) and (min-width:601px) {
            .s2_ib_inr_left, .s2_ib_inr_right {
                float: left;
            }
        }

        @@media screen and (max-width: 600px) and (min-width:595px) {
            .flight_form_container3 input[type=checkbox]:not(old) + label {
                margin-left: -300px;
            }
        }

        @@media screen and (max-width: 550px) and (min-width:430px) {
            .flight_form_container3 input[type=checkbox]:not(old) + label {
                margin-left: -250px;
            }
        }

        @@media screen and (max-width: 600px) {
            .tcc_threetabs {
                width: 50%;
            }

            .ffc2_r1_b3 {
                margin-left: 2%;
            }

            .s2_ib_inr_left, .s2_ib_inr_right {
                width: 100%;
            }

            .ffc2_r2_b5 .yellow_toll_tip {
                right: 0px;
            }

            .s2_mil_left {
                width: 75px;
                margin-left: -15px;
            }

            .s2_mcbml_inner_left {
                width: 51%;
            }

            .center {
                padding-left: 33%;
            }

            .s2_ib_inr_right2 {
                width: 70% !important;
                padding-left: 35%;
            }


            .s2_mcb_io_left2 {
                height: 80px;
                line-height: 30px;
                padding: 10px;
                padding-left: 25px !important;
            }
        }

        @@media screen and (min-width : 501px) {
            .s2-1_form_toll_tip_1 {
                right: 0;
                left: 0;
                margin: auto;
            }
        }

        @@media screen and (max-width: 500px) {
            .s2_mcbcb1r_button {
                margin-top: 0;
            }

            .s2_mcbml_inner_left {
                width: 48%;
                float: left;
            }

            .s2_mcbml_inner_right {
                width: 50%;
                float: right;
                margin-top: 0px;
            }

            .s2_mil_left {
                margin-left: -18px;
                margin-top: 20px;
            }

            .s2_mcbml_ir_left {
                width: 28%;
            }

            .s2_mcbml_ir_mid {
                width: 25%;
            }

            .s2_mcbml_ir_right {
                width: 47%;
            }

            .s2_mil_l_ico {
                float: none;
            }

            .s2_mil_l_text {
                float: none;
                padding-left: 0px;
                padding-top: 0px;
            }

            .s2-1_tt_right {
                text-align: left;
            }

            .s2-1_form_toll_tip {
                right: -58px !important;
            }

            .s2_mcbmlid_dc_mid {
                width: 37%;
            }

            .s2_mcbmlid_dc_left {
                width: 30%;
            }

            .s2_mcbmlid_dc_right {
                width: 33%;
            }
        }

        @@media screen and (max-width : 425px) {
            .s2_mcbc_b1l_right {
                width: 32%;
                margin-right: 15px;
            }

                .s2_mcbc_b1l_right > .s2mcbc_b1lr_text2 {
                    margin-top: inherit;
                }

                    .s2_mcbc_b1l_right > .s2mcbc_b1lr_text2 > text {
                        float: left;
                        margin-right: 0.5em;
                    }

                    .s2_mcbc_b1l_right > .s2mcbc_b1lr_text2 span {
                        float: left;
                        clear: both;
                    }

                    .s2_mcbc_b1l_right > .s2mcbc_b1lr_text2 > .s2-1_form_toll_tip > .s3-1_form_toll_tip_b > .s2-1_tt_right span {
                        float: none;
                    }

            .flight_form_container3 input[type=checkbox]:not(old) + label {
                margin-left: -210px;
            }

            .s2_ib_inr_right2 {
                width: 80% !important;
                padding-left: 30%;
            }
        }

        @@media screen and (max-width : 422px) {
            .s2_mil_left {
                margin-left: 0px;
                margin-top: 0px;
                width: 25%;
            }

            .s2_mil_right {
                width: 70%;
            }
        }

        @@media screen and (max-width : 375px) {
            .s2_mcbc_b1l_right {
                width: 35%;
            }

            .flight_form_container3 input[type=checkbox]:not(old) + label {
                margin-left: -190px;
            }
        }

        @@media screen and (max-width : 364px) {
            .s2_mcbml_ir_left {
                width: 35%;
            }

            .s2_mcbml_ir_mid {
                width: 23%;
            }

            .s2_mcbml_ir_right {
                width: 42%;
            }

            .optiondura {
                font-size: 15px;
                padding-right: 1px;
            }
        }

        @@media screen and (max-width : 333px) {
            .flight_form_container3 input[type=checkbox]:not(old) + label {
                margin-left: -170px;
            }

            .s2_mcbc_b1l_right {
                width: 40%;
                margin-right: 20px;
            }

            .s2_sf_left {
                width: 37% !important;
            }

            .s2_sf_mid {
                width: 22% !important;
            }

            .s2_sf_right {
                width: 41% !important;
            }

                .s2_sf_right span {
                    font-size: 15px;
                }
        }

        @@media screen and (max-width: 900px) {
            .s3_1_fdb_inner_b33 {
                width: 50% !important;
            }

            .s3_1_fdb_i3_da_lable3 {
                padding-left: 0;
                text-align: center;
            }

            .s3_1_fdb_i3_da_timing {
                float: none !important;
            }

                .s3_1_fdb_i3_da_timing .tim_box {
                    float: none !important;
                }

                .s3_1_fdb_i3_da_timing .img_box {
                    float: none !important;
                }

            .s3_1_fdb_small2 {
                margin-left: 0;
            }

            .s3_1_flight_details_box {
                padding-bottom: 25px !important;
                padding-top: 10px !important;
            }

            .s2_ib_inr_right {
                width: 100%;
            }
        }

        @@media screen and (max-width: 600px) {
            .s3_1_fdb_i3_da_lable3 {
                padding-left: 0;
                text-align: center;
            }

            .s3_1_fdb_i3_da_timing {
                float: none !important;
            }

                .s3_1_fdb_i3_da_timing .tim_box {
                    float: none !important;
                }

                .s3_1_fdb_i3_da_timing .img_box {
                    float: none !important;
                }

            .s3_1_fdb_small2 {
                margin-left: 0;
            }

            .s3_1_fdb_i3_da_lable2 {
                width: 100%;
            }

            .s2_mcbc_b1_left {
                width: 100%;
                float: none;
                border-right: 0px;
            }

            .s2_mcbc_b1_right {
                width: 100%;
                float: none;
            }

            .s2-1_form_toll_tip {
                right: -20px;
            }

            .s2_mcbcb1r_button {
                margin-top: 0;
            }
        }

        @@media screen and (max-width: 900px) and (min-width: 601px) {
            .mob_passengerdetails {
                width: 100%;
                padding-top: 15px;
            }

            .s2_ml_20 {
                margin-left: 40% !important;
                width: 22%;
            }

            .s3_1_fdb_inner_b3 {
                border-right: none;
            }
        }
    </style>
    <!-- Slider jquery.ui Customize End-->
}

@Html.Partial("~/Views/Shared/MasterThemes/_OopsBox.cshtml")
@if (!Model.SearchFlightResultViewModel.IsFixedPrice)
{
@Html.Partial("~/Views/Flight/Search/_ModifySearchPanel.cshtml")
}
@Html.Partial("~/Views/Shared/MasterThemes/_PopOutModal.cshtml")

<div id="fareRulesClass" style="display: none;">
    @Html.Partial("~/Views/Flight/Shared/_FareRulesView.cshtml", new List<Alphareds.Module.Model.FlightSegmentFareRule>())
</div>

<!-- INFORMATION BOX START -->
@Html.Partial("~/Views/Flight/Shared/_FlightSearchSummarybar.cshtml", Model.SearchFlightResultViewModel)
<!-- INFORMATION BOX END -->
<!-- FILTER CONTAINER START -->
@using (Html.BeginForm("Search", "Flight", new { tripid }, FormMethod.Post, new { @class = "form-inline flight-filter-panel", @id = "form" }))
{
    if (Request.IsAjaxRequest())
    {
        @Html.Partial("~/Views/Flight/Search/_FlightFilterPanel.cshtml")
    }
}
<!-- FILTER CONTAINER END -->
@*<div class="s2_img_container">
        <img src="~/Images/promotion/AA_desktop_banner.jpg" />
    </div>*@
<div class="loadingArea">
    <div class="s2_main_container">
        <div class="s2_mc_border_conainer loading" style="display:none;">
            <div style="height: 360px;width: 100%;margin: 2em 0px;display: table;text-align: center;">
                <div style="display: table-cell;vertical-align: middle;text-align:center;">
                    <img src="@Url.Content("~/Images/mayflower_loading.gif")" width="120">
                    <p id="msglbl" style="color:#808080;margin:1em">Hold on, your holiday is on the way...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- MAIN CONTENT PORTION START -->
    @if (Model.SearchFlightResultViewModel.IsFixedPrice)
    {
        <div class="row fixedtitlerow">
            <div class="col-lg-12 flt_fixedtitle"><img src="~/Images/Icons_Hotels.png" /><b>Pick Your Stay<img class="fixedtitlearrow" src="~/Images/arrow-32-xxl.png" /><img src="~/Images/Icons_Flights.png" />Select Your Flight</b></div>
        </div>
        <div class="clearfix"></div>
    }
    <div id="result-content" class="s2_main_container @fixedres_css">

        @if (Request.IsAjaxRequest())
        {
            @Html.Partial("~/Views/Flight/Search/_FlightSearchResultList.cshtml")
        }
    </div>
    <div id="fixedpackage-content">

    </div>
    <div class="clearfix"></div>
</div>
@Html.Partial("~/Views/Shared/MasterThemes/_LoadingModal.cshtml")
@Html.Partial("~/Views/Shared/Theme_3/_BootstrapModal.cshtml")

@section scripts{
    @Html.Partial("~/Views/Flight/Shared/_SearchWidgetScripts.cshtml")
    @Html.Partial("~/Views/Flight/Shared/_FareRulesScriptPartial.cshtml")
    <script>
        var isLogin = false;
        var tripId = '@tripid';
        @if (User.Identity.IsAuthenticated)
        {
            @:var isLogin = true;
        }

        var pairingOption;
        //$.ajaxSetup({ cache: false });

        $(document).ready(function (e) {
            //Prevent safari loading from cache when back button is clicked
            $(window).bind("pageshow", function (event) {
                if (event.originalEvent.persisted) {
                    window.location.reload()
                }
            });
            //end of Prevent safari loading from cache when back button is clicked

            history.pushState('', '', window.location.href);

            var toggleLoadArea = function (option) {
                option = option == undefined ? 'slow' : option;
                $('.s2_main_container .loading, #result-content, #form').fadeToggle(option);
            }

            $.getFlightPanel = function () {
                return $.ajax({
                    type: "POST",
                    cache: false,
                    url: '/Flight/_FlightFilterPanel',
                    async: true,
                }).then(function (res) {
                    $("#form").html(res);
                    //loadbubblefilter();
                    $.getScript('@Url.Content("~/Scripts/slider.js")');
                    $("#content-4").mThumbnailScroller({
                        type: "click-50",
                        theme: "buttons-out",
                        callbacks: {
                            //onTotalScroll: function () {
                            //    $.get("ajax.html", function (data) {
                            //        $("#content-3 .mTSContainer").append(data); //load new content inside .mTSContainer
                            //    });
                            //}
                        }
                    });
                    if ($(window).width() > 900) {
                        $('.s2_fil_inl_filboxes[value="filter-airlines"]').click();
                    }
                }, function (res) {
                    $("#result-content").html(res);
                    toggleLoadArea(400);
                    setTimeout(function (e) {
                        $('#oopsbox').fadeIn();
                    }, 500);
                }).promise();
            };

            $.getFlightList = function () {
                return $.ajax({
                    //type: "GET",
                    url: '/Flight/Search',
                    cache: false,
                    async: true,
                    //contentType: "application/json",
                    beforeSend: function () { toggleLoadArea(); },
                }).promise();
            };

            $.getPackageDtl = function () {
                return $.ajax({
                    url: '/Flight/_FlightPackageDetail?tripId=' + tripId,
                    cache: false,
                    async: true,
                }).promise();
            };

            $.getFlightList().then(
                function (res) {
                    // success
                    $.getFlightPanel().done(function (e) {
                        $("#result-content").html(res);
                        $.getFlightResultOption().then(function (list) {
                            pairingOption = list;
                            ecomimpressions();
                        });
                        // initialize first pairable flight option
                        //pairList();
                        $.showMoreFlightMobile();
                        toggleLoadArea();
                        $.getPackageDtl().then(function(result){
                            $("#fixedpackage-content").html(result);
                            $(".fixedtitlerow").show();
                        });
                    });
                }, function (res) {
                    // failed
                    toggleLoadArea(400);
                    setTimeout(function (e) {
                        $('#oopsbox').fadeIn();
                    }, 500);
                });

            var isValid = @Html.Raw(Json.Encode(ViewData.ModelState.IsValid));
            var errorsMsg = @Html.Raw(Json.Encode(string.Join(Environment.NewLine,ViewData.ModelState.Where(x => x.Value.Errors.Count > 0).SelectMany(x => x.Value.Errors).Select(error => error.ErrorMessage))));

            if (!isValid && errorsMsg == "Oops...the fare you chosen is no longer available.. Please try to search again.")
            {
                var confirmFunction = 'getFList();';

                //$('#popup-modal').show();
                //$('#modal-container').html("<div class='session_lb_text'>Oops...</div><div class='session_lb_text1'>The fare you chosen is no longer available.. Please try to search again.</div><a href='javascript:;' class='modal-close' style='text-decoration:none'><div class='redirectSearch_button'>Search Again</div></a>");

                $(".btn.modal-confirm").attr("onclick", confirmFunction);
                dynamicModal('INFO', errorsMsg, true).modal();
                $(".redirectSearch_button").attr("onclick", confirmFunction);
            }

            var infantNo = $("#SearchFlightResultViewModel_Infants").val();
            if (infantNo > 0) {
                $("#infantremindertext").show();
            }
        });

        function getFList() {
        window.location.href = '@Url.Action("RedirectSearch", "Flight")?tripId=' + tripId;
        };

        $(document).ajaxComplete(function () {
            loadbubblefilter();
        });
        function loadbubblefilter() {
            var air = $(".filter-airline-active > .s2_filter_ab_fli_airlineName").text();
            if (air == "") {
                $(".fillter_tags.Bottom_blue_bg").text("");
            } else {
                $(".fillter_tags.Bottom_blue_bg").text(toTitleCase(air) + " X");
            }
            $(".fillter_tags.outdep").text(localStorage.getItem("outbdep"));
            $(".fillter_tags.outarr").text(localStorage.getItem("outbarr"));
            $(".fillter_tags.indep").text(localStorage.getItem("inbdep"));
            $(".fillter_tags.inarr").text(localStorage.getItem("inbarr"));
            $(".fillter_tags.Bottom_yellow_bg").text(localStorage.getItem("pricefil"));
            if (localStorage.getItem("pricefil") != null) {
                $(".fillter_tags.Bottom_yellow_bg").show();
            }
            var stopfil = [];
            var stoplen = $(".s2_sf_left > input").length;
            var stopchecked = $(".s2_sf_left > input:checked").length;
            $(".s2_sf_left > input:checked + label").each(function (index, obj) {
                stopfil.push($(this).text());
            });
            if (stopfil != "" && stopchecked < stoplen) {
                $(".fillter_tags.Bottom_pink_bg").text(stopfil.join(', ') + " X");
                $(".fillter_tags.Bottom_pink_bg").show();
            } else {
                $(".fillter_tags.Bottom_pink_bg").text("");
            }
        }
        $('#result-content').on('click', '.select-flight-btn,#guest-btn', function (e) {
            e.preventDefault();
            var grpID = $(this).data('index');
            $('#guest-btn').attr('data-index', grpID);
            selectFlight(grpID);
        });
        $('#result-content').on('click', '.save-flight-btn,#guest-btn', function (e) {
            e.preventDefault();
            var grpID = $(this).data('index');
            $('#guest-btn').attr('data-index', grpID);
            var isLink = $(this).hasClass("generateLink");
            selectFlight(grpID, false, isLink);
        });

        $(document).on('click', '#filter-airlines ul li > div', function (e) {
            var air = $(this).data('air');
            $('.filter-airline-active').removeClass('filter-airline-active');
            $(this).addClass('filter-airline-active');
            $('#filter-airlines').find('input[type="hidden"]').eq(0).val(air);
            focusFlightResult();
            filterAirline();
            if (air == "") {
                $(".fillter_tags.Bottom_blue_bg").text("");
            } else {
                $(".fillter_tags.Bottom_blue_bg").text(toTitleCase($(".filter-airline-active > .s2_filter_ab_fli_airlineName").text()) + " X");
            }
        });
        function toTitleCase(str) {
            return str.replace(/\w\S*/g, function (txt) { return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase(); });
        }

        $(document).on('click', '.ModifySearchButton', function (e) {
            var fromval = $(".from-value").val();
            var toval = $(".to-value").val();
            if (fromval != '') {
                $('.from-value').removeClass('input-validation-error').addClass('valid');
                $('#from-error').hide();
            }
            if (toval != '') {
                $('.to-value').removeClass('input-validation-error').addClass('valid');
                $('#to-error').hide();
            }
        });

        $(document).on('click', '.reset-filter', function (e) {
            $('.filter-airline-active').removeClass('filter-airline-active');
            $('#show-allairline').addClass('filter-airline-active');
            $('#filter-airlines').find('input[type="hidden"]').eq(0).val('');
            $(".fillter_tags").text("");
            localStorage.removeItem("outbdep");
            localStorage.removeItem("outbarr");
            localStorage.removeItem("inbdep");
            localStorage.removeItem("inbarr");
            localStorage.removeItem("pricefil");
            focusFlightResult();
            $("#form").hide();
            filterAirline(true).then(function (e) {
                $.getFlightPanel().done(function (e) {
                    $("#form").slideDown();
                });
            })
        });

        $(document).on('click', '.fillter_tags.Bottom_blue_bg', function (e) {
            $("#show-allairline").trigger('click');
        });

        $(document).on('click', '.fillter_tags.outdep', function (e) {
            $("#outDepMin").val("0");
            $("#outDepMax").val("1440");
            filterAirline().then(function (e) {
                $.getFlightPanel().done(function (e) {
                    localStorage.removeItem("outbdep");
                    loadbubblefilter()
                });
            });
        });
        $(document).on('click', '.fillter_tags.outarr', function (e) {
            $("#outArrMin").val("0");
            $("#outArrMax").val("1440");
            filterAirline().then(function (e) {
                $.getFlightPanel().done(function (e) {
                    localStorage.removeItem("outbarr");
                    loadbubblefilter()
                });
            });
        });
        $(document).on('click', '.fillter_tags.indep', function (e) {
            $("#inDepMin").val("0");
            $("#inDepMax").val("1440");
            filterAirline().then(function (e) {
                $.getFlightPanel().done(function (e) {
                    localStorage.removeItem("inbdep");
                    loadbubblefilter()
                });
            })
        });
        $(document).on('click', '.fillter_tags.inarr', function (e) {
            $("#inArrMin").val("0");
            $("#inArrMax").val("1440");
            filterAirline().then(function (e) {
                $.getFlightPanel().done(function (e) {
                    localStorage.removeItem("inbarr");
                    loadbubblefilter()
                });
            })
        });
        $(document).on('click', '.fillter_tags.Bottom_yellow_bg', function (e) {
            $("#FilterFlightModel_PriceMin").val("0");
            $("#FilterFlightModel_PriceMax").val("99999")
            filterAirline().then(function (e) {
                $.getFlightPanel().done(function (e) {
                    localStorage.removeItem("pricefil");
                    loadbubblefilter()
                });
            })
        });
        $(document).on('click', '.fillter_tags.Bottom_pink_bg', function (e) {
            var arrStop = new Array();
            $('#stop_filter').find('input[type="checkbox"]').prop("checked", true);
            $('#stop_filter').find('input[type="checkbox"]:checked').each(function (i) {
                arrStop.push($(this).val());
            });
            filterAirline()
            $(".fillter_tags.Bottom_pink_bg").text("");
        });
        $(document).on('click', '#stop_filter input[type="checkbox"]', function (e) {
            filterAirline();
            var stopfil = [];
            var stoplen = $(".s2_sf_left > input").length;
            var stopchecked = $(".s2_sf_left > input:checked").length;
            $(".s2_sf_left > input:checked + label").each(function (index, obj) {
                stopfil.push($(this).text());
            });
            if (stopfil != "" && stopchecked < stoplen) {
                $(".fillter_tags.Bottom_pink_bg").text(stopfil.join(', ') + " X");
            } else {
                $(".fillter_tags.Bottom_pink_bg").text("");
            }
        });

        var pairList = function () {
            $('.flight_group_container').each(function (index, element) {
                $(element).find('input').eq(0).trigger('change');
            });
        }

        var focusFlightResult = function () {
            $('html, body').animate({
                scrollTop: $(".s2_main_container").offset().top
            }, 300);
        };

        function filterAirline(reset) {
            var val = new Array();
            var arrStop = new Array();
            var sort = $('#sort-option').val();
            var isReset = (typeof reset != "undefined");

            $('#filter-airlines').find('input[type="hidden"]').each(function (i) {
                val[i] = $(this).val();
            });

            if (!isReset) {
                $('#stop_filter').find('input[type="checkbox"]:checked').each(function (i) {
                    arrStop.push($(this).val());
                });
            }

            $.filterFlightList = function () {
                return $.ajax({
                    url: '/Flight/Search?filterstatus=true&sort=' + sort,
                    async: true,
                    cache: false,
                    traditional: true,
                    contentType: "application/json",
                    data: {
                        PriceMin: isReset ? 0 : $("#FilterFlightModel_PriceMin").val(),
                        PriceMax: isReset ? 99999 : $("#FilterFlightModel_PriceMax").val(),
                        StopList: arrStop,
                        Airline: val,
                        OutDepartureTimeMin: isReset ? 0 : $("#outDepMin").val(),
                        OutDepartureTimeMax: isReset ? 1440 : $("#outDepMax").val(),
                        OutArrivalTimeMin: isReset ? 0 : $("#outArrMin").val(),
                        OutArrivalTimeMax: isReset ? 1440 : $("#outArrMax").val(),
                        InDepartureTimeMin: isReset ? 0 : $("#inDepMin").val(),
                        InDepartureTimeMax: isReset ? 1440 : $("#inDepMax").val(),
                        InArrivalTimeMin: isReset ? 0 : $("#inArrMin").val(),
                        InArrivalTimeMax: isReset ? 1440 : $("#inArrMax").val(),
                    },
                    beforeSend: function () {
                        //focusFlightResult();
                        $("#result-content").html('');
                        $('.s2_main_container .loading').toggle();
                        //run_waitMe('form-inline', 'ios');
                    },
                }).promise();
            };

            return $.filterFlightList().then(
                //done
                function (res) {
                    focusFlightResult();
                    $("#result-content").html(res);
                    // initialize first pairable flight option
                    //pairList();
                    $.getFlightResultOption().then(function (list) {
                        pairingOption = list;
                        ecomimpressions();
                    });
                    $.showMoreFlightMobile();
                    $('.s2_main_container .loading').toggle();
                    //close_waitMe('form-inline', 'ios');
                },
                //fail
                function (res) {
                    $('.s2_main_container .loading').toggle();
                    //close_waitMe('form-inline', 'ios');
                    setTimeout(function (e) {
                        $('#oopsbox').fadeIn();
                    }, 500);
                }
            ).promise();
        }

        $.checkIsPairable = function (outb, inb, grpT) {
            var params = { outbound: outb, inbound: inb, grpTag: grpT };
            $('#loading-modal').show();

            return $.ajax({
                url: '/Flight/IsFlightPairable' + '?' + $.param(params),
                method: 'POST',
                async: true,
                cache: false,
                //contentType: "json",
            }).promise();

            @*var pair = false;
            return $.ajax({
                url: '/Flight/IsFlightPairable' + '?' + $.param(params),
                method: 'POST',
                async: true,
                cache: false,
                //contentType: "json",
            }).then(function (res) {
                pair = res;
            });

            return pair;*@
        };

        $.showMoreFlightMobile = function () {
            if ($(window).width() < 900) {
                $('.flight_group_container').each(function (index, element) {
                    $('.showmoredata.' + element.id).show();
                });
            }
        };

        var selectFlight = function (grpID, isSelectFlight, isLink) {
            isSelectFlight = typeof isSelectFlight == "boolean" ? isSelectFlight : true;
            var optionChecked = $('#' + grpID).find('input[type="radio"]:checked');

            var position = parseInt($('#' + grpID).data('gapo'));
            var stop = optionChecked.data('stop');
            if (isSelectFlight) {
                ecomselect((isNaN(position) ? 0 : position), stop);
            }

            var isRound = $('#' + grpID).has('.inbound_click').length;
            var outB = optionChecked.eq(0).val();
            var outBODO = optionChecked.eq(0).data('odo');

            if (optionChecked.length > 1) {
                var inB = optionChecked.eq(1).val();
                var inBODO = optionChecked.eq(1).data('odo');

                $.checkIsPairable(outBODO, inBODO, grpID).done(function (res) {
                    var isPairable = res;
                    if (isPairable == false && typeof isPairable == "boolean") {
                        //alert('Selected flight is not availaible.');
                        $('#popup-modal').show();
                        $('#modal-container').html("<div class='session_lb_text'>Sorry</div><div class='session_lb_text1'>Selected flight is not availaible for this departure time.</div><a href='javascript:;' class='modal-close' style='text-decoration:none'><div class='redbacktohome_button'>Close</div></a>");
                        return;
                    }
                    else if (typeof isPairable != "boolean") {
                        ecomremove();
                        $("#result-content").html(isPairable);
                        return;
                    }
                    //$('#loading-modal').hide();
                });
            }

            var url = isSelectFlight ? "@Url.Action("Search", "Flight")" : "@Url.Action("SaveFlightDtl", "Flight")";

            var params = { outbound: outBODO, inbound: inBODO, grpTag: grpID, tripid: '@tripid' };

            if ((!isRound && optionChecked.length == 1) || (isRound && optionChecked.length == 2)) {
                if (isSelectFlight) {
                    $('<form action="' + url + '?' + $.param(params) + '" method="POST" />')
                    .appendTo($(document.body))
                    .submit();
                } else {
                    if (isLink) {
                        linkFlt(url, params);
                    }
                    else if (isLogin) {
                        saveFlt(url, params);
                    } else {
                        $('#loading-modal').hide();
                        loginBox();
                    }
                }
            }
            else {
                $('#popup-modal').show();
                $('#modal-container').html("<div class='session_lb_text1' style='color: #000'>Looks like you have not select any flights. Go back to pick your desired one.</div><a href='javascript:;' class='modal-close'><div class='redbacktohome_button' style='margin-top: 1em;display: inline-block;'>Ok</div></a>");
            }
        }

        var saveFlt = function (url, param) {
            $.ajax({
                type: "POST",
                cache: false,
                url: url,
                data: param,
                async: true,
            }).then(function (res) {
                setTimeout(function (e) {
                    $('#loading-modal').hide();
                    $('#popup-modal').show();
                    $('#modal-container').html("<div class='session_lb_text1' style='color: #000'>Your selected flights are saved in your profile for easy booking in future</div><a href='javascript:;' class='modal-close'><div class='redbacktohome_button' style='margin-top: 1em;display: inline-block;'>Ok</div></a>");
                }, 500)
            }, function (res) {
                setTimeout(function (e) {
                    $('#oopsbox').fadeIn();
                }, 500);
            }).promise();
        }

        var linkFlt = function (url, param) {
            $.ajax({
                type: "POST",
                cache: false,
                url: '@Url.Action("GenerateFlightLink", "Flight")',
                data: param,
                async: true,
            }).then(function (res) {
                setTimeout(function (e) {
                    $('#loading-modal').hide();
                    $('#popup-modal').show();
                    $('#modal-container').html("<div class='session_lb_text1' style='color: #000; word-wrap:break-word;'>The link for your selected flights is <br/><br/>" + res.link + "</div><a href='javascript:;' class='modal-close'><div class='redbacktohome_button' style='margin-top: 1em;display: inline-block;'>Ok</div></a>");
                }, 500)
            }, function (res) {
                setTimeout(function (e) {
                    $('#oopsbox').fadeIn();
                }, 500);
            }).promise();
        }

        var toggleLoadSection = function (result) {
            focusFlightResult();
            if (typeof result == "undefined") {
                $("#result-content").html('');
            }
            else {
                $("#result-content").html(result);
            }
            $('.s2_main_container .loading').toggle();
        }

        $(".s3_1_fdb_modify_icon, .modifysearch_white1nn > .loginclose").click(function () {
            $("[name='SearchFlightResultViewModel.DepartureStation']").val(searchCriteria.DepartureStation);
            $("[name='SearchFlightResultViewModel.ArrivalStation']").val(searchCriteria.ArrivalStation);
            $("[name='SearchFlightResultViewModel.PrefferedAirlineCode']").val(searchCriteria.PrefferedAirlineCode);
            $("[name='SearchFlightResultViewModel.BeginDate']").val(moment(searchCriteria.BeginDate, 'YYYY/M/D').format('DD-MMM-YYYY'));
            $("[name='SearchFlightResultViewModel.EndDate']").val(moment(searchCriteria.EndDate, 'YYYY/M/D').format('DD-MMM-YYYY'));
            $("[name='SearchFlightResultViewModel.Adults']").val(searchCriteria.Adults);
            $("[name='SearchFlightResultViewModel.Childrens']").val(searchCriteria.Childrens);
            $("[name='SearchFlightResultViewModel.Infants']").val(searchCriteria.Infants);
            $("[name='SearchFlightResultViewModel.CabinClass']").val(searchCriteria.CabinClass);
            if (!$(".fullcover_div6").is(':visible')) {
                $(".fullcover_div6").fadeIn();
            }
        });

        $('#result-content').on('click', 'input[type=radio]', function () {
            $(".s2_mcb_io_left").removeClass("s2_mcb_io_left2");
        });
        $(".modifysearch_white1nn").on('click', ".mswi_withflying_right button[type='submit']", function () {
            localStorage.removeItem("outbdep");
            localStorage.removeItem("outbarr");
            localStorage.removeItem("inbdep");
            localStorage.removeItem("inbarr");
            localStorage.removeItem("pricefil");
        });

        //sort by button color -- start--//
        $(document).on('click', '.s2_fil_in_right_sm.bestdeal, .s2_fil_in_right_sm.fastroute, .s2_fil_in_right_sm.shortduration', function () {
            $('.widget-footer2').removeClass('widget-footer2');
            $(this).toggleClass('widget-footer2');
        });
        //sort by button color -- end--//

        $("#SearchFlightResultViewModel_Infants").on('change', function () {
            var infantNo = $("#SearchFlightResultViewModel_Infants").val();
            if (infantNo > 0) {
                $("#infantremindertext").show();
            }
            else {
                $("#infantremindertext").hide();
            }

        });

        var loginBox = function () {
            if (typeof isLogin != "undefined") {
                var isLoginBoxVisible = $(".fullcover_div").is(':visible');
                if (!isLoginBoxVisible) {
                    $(".fullcover_div").fadeIn();
                    $("body").addClass("modal-open");
                    $(".tlla_left").removeClass("posabs");
                    $(".tlla_left").addClass("posinherit");
                    $(".fcd_login_nomember_container").html("Please login to use the save function.");
                    return false;
                }
            }
            return true;
        }
    </script>
    <script type="text/javascript" src="~/Scripts/v3.0/page-scripts.js"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/flight/step2.js")" async></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
}