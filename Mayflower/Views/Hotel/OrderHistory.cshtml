@model Alphareds.Module.Model.Database.BookingHotel
@using Alphareds.Module.ServiceCall;
@using Alphareds.Module.Common;

@{
    ViewBag.Title = "Order History";
    ViewBag.HeaderRed = true;

    var qryStatus = Request.QueryString["status"];
    bool fromPaymentGateway = qryStatus != null ? qryStatus.ToString() == "success" : false;
    TimeSpan stayDay = Model.CheckOutDateTime.Subtract(Model.CheckInDateTime);

    var db = new Alphareds.Module.Model.Database.MayFlower();
    var taxRate = db.TaxCodeTypes.FirstOrDefault(x => x.TaxCode == "SR").TaxPercentage;
    decimal hotelStar = decimal.TryParse(Model.HotelRating, out hotelStar) ? Convert.ToInt16(Math.Ceiling(hotelStar)) : 0;
    List<string> addressList = new List<string>();
    addressList.Add(Model.HotelAddress);
    addressList.Add(Model.HotelPostalCode);
    addressList.Add(Model.HotelCity);
    addressList.Add(Alphareds.Module.Common.UtilitiesService.GetCountryName(Model.HotelCountryCode));
    addressList.RemoveAll(x => x == null);
    string bkStatus = Model.SuperPNR.SuperPNROrders.All(x => x.BookingStatusCode == "CON") && Model.BookingStatusCode == "CON" ? "CON"
        : Model.SuperPNR.SuperPNROrders.All(x => x.BookingStatusCode == "EXP" && x.PaymentOrders.All(u => u.PaymentStatusCode == "EXP" || u.PaymentStatusCode == "VOID")) && Model.BookingStatusCode == "EXP" ? "EXP"
        : "RHI";
    string classWithTick = string.Empty;
    //var feeChargeHotel = Model.FeeChargeHotels != null && Model.FeeChargeHotels.LastOrDefault() != null ? Model.FeeChargeHotels.LastOrDefault() : null;
    var feeChargeHotel = Model.SuperPNR.SuperPNROrders.FirstOrDefault(x => x.OrderID == Model.OrderID).FeeChargeOrders.LastOrDefault();
    bool isNotConfirmBook = bkStatus == "RHI" || bkStatus == "EXP" || Model.SuperPNR.SuperPNROrders.Any(x => x.BookingStatusCode != "CON");

    if (bkStatus != "CON")
    {
        classWithTick = "st4_payment_heading_container1_without_tick";
    }
    else
    {
        classWithTick = "st4_payment_heading_container1";
    }
}

@section priorityScript{
    <script>
        if (typeof sessionStorage.searchKeyH !== 'undefined' && sessionStorage.searchKeyH !== '' && sessionStorage.searchKeyH !== '{}') {
            var GTM_trackHotelSearchCriteria = JSON.parse(sessionStorage.searchKeyH);
            sessionStorage.removeItem('searchKeyH');
        }
    </script>
}

@section style{
    <link rel="stylesheet" href="@Url.Content("~/CSS/v2style.css")" type="text/css" />
    <link rel="stylesheet" href="@Url.Content("~/CSS/v2responsive.css")" type="text/css" />
    <link rel="stylesheet" href="@Url.Content("~/CSS/hotel/bootstrap-carousel.css")">

    <style>
        .s3_hotel_name_portion2 {
            display: inline-block;
        }

        .s3_hotel_name_portion1 {
            float: left;
        }

        .h2_mhdb2_heading2 {
            background-image: url(../images/info-icon.png);
            background-repeat: no-repeat;
            font-size: 14px;
            float: left;
            margin-left: 10px;
            margin-top: -6px;
            color: #ec1c24;
            min-width: 55px;
            height: 35px;
        }

        .s5_hotel_name_portion {
            float: left;
            color: #000;
            margin-right: 15px;
            font-size: 17px;
        }

        .pgt_left {
            width: 100%;
        }

        .mf_ib_border_box {
            margin-bottom: 60px;
        }

        .pdcont_nameleft2 {
            float: left;
            width: 15%;
            display: inline-block;
        }

        .mpjm_spclclass_mt {
            float: left;
        }

        .mpjm_spclclass_mt, .pdcont_nameright {
            display: inline-block;
        }

        .pdcont_nameleft {
            width: 100%;
        }

        .pdcont_nameright {
            width: 85%;
        }

        .mf_ib_bb_lrbox_inner {
            max-width: 100% !important;
        }

        .mf_ib_border_box {
            background: none;
        }

        .mf_ib_bb_lrbox {
            width: 100%;
        }

        .inboundoutbound_heading {
            background-color: #ffffff !important;
            text-align: center;
        }

        .s4_blt_py_container {
            border: 1px solid #d5d5d5;
            width: 90% !important;
            padding: 2% 5% 2% 5%;
        }

        .payment_tab_active .pgt_right {
            color: initial !important;
        }

        .s4_blue_top_pati .pgt_right_detail {
            float: right;
            margin-right: 28px;
            padding-right: 48px;
            font-size: 16px;
        }

        .s4_payment_heading {
            background-image: url(../images/guest_icon_hotel.png);
            color: #414042;
        }

        .s4_blt_heading {
            background-image: url(../images/cal_bg1.png);
            color: #00a298;
        }

        .s4_blue_top_pati, .mpjm_pd_heading_left {
            background-color: #929497;
        }

        .s4_guest_tabs_name_container h3, .s4_guest_tabs_name_container h4 {
            color: #231F20;
        }

        .s3_hotel_name_portion3_customize {
            margin-left: 20px;
            float: right;
        }

        /* I'm Seperator START */
        .fullcover_div_GoogleMap {
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 999999;
            display: none;
        }

        .viewmorehotel_container.hotel-info {
            margin: auto !important;
        }

        .viewmorehotel_container {
            max-width: 883px;
            width: 96%;
            margin: 2em auto;
            height: 500px;
        }

        .viewmorehotel_white1nn {
            height: 510px;
            overflow: auto;
            text-align: center;
        }

        .vm_inner_content {
            width: 95%;
            margin: auto;
            text-align: left;
        }

        .field_error_msg {
            margin-top: 0px;
        }

        .ipay_paynow_button1 {
            top: 100px;
        }

        .s5_pl_button {
            background-color: #ee3739;
        }

        .ipay_paynow_button1 {
            background-color: #ee3739;
        }

        /* I'm Seperator END */

        .ipay_paynow_button1, .s5_pl_button {
            width: 210px;
        }

        #printForm {
            display: inline-block;
            float: right;
        }

        @@media screen and (max-width : 900px) {
            .ipay_paynow_button1, .s5_pl_button {
                top: 0;
                margin-top: 0;
                width: 190px;
            }

            .pdcont_nameright {
                width: 78%;
            }

            .pdcont_nameleft2 {
                float: left;
                width: 20%;
                display: inline-block;
            }

            .s3_hotel_contacts_box {
                margin: 10px;
            }

            .s5_hotel_name_portion {
                width: 100%;
            }

            .s3_hotel_name_portion1 {
                width: 100%;
            }

            .s3_hotel_name_portion2 {
                margin-top: 10px;
            }
        }

        @@media screen and (max-width : 600px) {
            .st4_payment_heading_container1 span {
                font-size: 23px;
            }

            /*.s4_blue_top_pati {
                    height: 100px;
                    line-height: 30px;
            }*/

            .s4_guest_tabs_name_container H3 {
                padding-top: 0px;
            }

            .mpjm_pd_heading_left {
                width: 60px;
                height: 60px;
                line-height: 60px;
                display: inline-block;
                float: left;
            }

            .pdcont_nameright {
                display: inline-block;
                width: 70%;
            }

            .ipay_paynow_button1, .s5_pl_button {
                top: 0;
                margin-top: 0;
                width: 150px !important;
            }

            .pdcont_nameleft2 {
                float: left;
                width: 30%;
                display: inline-block;
            }

            .s4_blt_py_con_left {
                width: 60%;
                float: left;
            }

            .s4_blt_py_con_right {
                float: right;
            }
        }

        @@media screen and (max-width : 400px) {
            .s4_blt_sub_heading {
                font-size: 13px;
                text-align: center;
            }

            .pgt_left {
                font-size: 19px;
            }

            .pgt_right {
                font-size: 14px;
                padding-top: 5px;
            }
        }
    </style>
}

<!-- FARE RULES LITEBOX START -->
<!-- FARE RULES LITEBOX END -->
<!-- LOGIN LITEBOX START -->
<!-- LOGIN LITEBOX END-->
<!-- TOP LOGO PORTION START -->
<!-- TOP LOGO PORTION END -->
<!-- GRAY BREADCRUMP START -->
<div class="s3_1_breadcrump">
    <div class="booking_refrence_text">Booking reference number <span>@Model.SuperPNRNo</span></div>
</div>
<!-- GRAY BREADCRUMP END -->
<!-- PAYMENT HEADING START -->
<div class="@classWithTick">
    @{ 
        var TrivagoTrackPixelUrl = TempData["TrivagoTrackPixelUrl"] != null ? TempData["TrivagoTrackPixelUrl"].ToString() : null;
        if (!string.IsNullOrEmpty(TrivagoTrackPixelUrl))
        {
            <img height="1" width="1" style="border-style:none;" alt="" src="@TrivagoTrackPixelUrl" />
        }
    }
    @if (bkStatus == "CON")
    {
        <span>Successful Payment</span>
        <text>A booking conﬁrmation email will be sent to your inbox. Thank you for choosing Mayﬂower, we look forward to seeing you soon.</text>
    }
    else if (bkStatus == "EXP")
    {
        <span>Expired</span>
        @:Booking failed.
    }
    else if (bkStatus == "RHI" || isNotConfirmBook)
    {
        string supportLine = Model.BundleID == 1 || Model.BundleID == 2 ? "+603 9232 1999" : "+603 9232 1888";

        <span>Pending Confirmation</span>
        @:A booking conﬁrmation email will be sent to your inbox. Please contact us at @supportLine to confirm your booking. Thank you for choosing Mayﬂower.
    }
</div>
<!-- PAYMENT HEADING END -->
<!-- MAIN CONTENT PORTION START -->
<div class="s3-1_form">
    <div class="payment_innerbox">
        <div class="payment_content_container">
            <div class="s3_hotel_topline"></div>

            @if (Model.BundleID != 0)
            {
                try
                {
                    @Html.Partial("~/Views/Hotel/BundleItem/_" + Model.BundleID + ".cshtml", Model)
                }
                catch (Exception ex)
                {
                    NLog.Logger logger = NLog.LogManager.GetCurrentClassLogger();
                    logger.Error(ex, "Bundles Package Item View Not Found.");
                }
            }

            <div class="s3_hotel_topline"></div>
            <div class="s4_blt_heading">Hotel Itinerary</div>
            <!-- FLIGHT DETAILS START -->
            <div class="s4_blt_sub_heading">@Model.CheckInDateTime.ToString("dd-MMM-yy, ddd") to @Model.CheckOutDateTime.ToString("dd-MMM-yy, ddd") | <span>@(stayDay.TotalDays + 1) Days @(stayDay.TotalDays) Nights</span></div>
            @*<div class="inboundoutbound_heading">@Model.CheckInDateTime.ToString("dd-MMM-yy, ddd") to @Model.CheckOutDateTime.ToString("dd-MMM-yy, ddd") | 5 Days 4 Nights</div>*@
            <div class="mf_ib_border_box">
                <!-- left detail start -->
                @{
                    string encSupplierCode = Mayflower.General.CustomizeBaseEncoding.CodeBase64(Model.SupplierCode);
                }
                <div class="mf_ib_bb_lrbox">
                    <div class="mf_ib_bb_lrbox_inner">
                        <div class="s3_hotel_name_portion1">
                            @Model.HotelName
                        </div>
                        <div class="s3_hotel_name_portion2">
                            @for (int i = 0; i < hotelStar; i++)
                            {
                                <img src="@Url.Content("~/images/hotel_star_am.png")" width="10" height="10" alt="">
                            }
                            <a class="s3_hotel_name_portion3_customize ShowHotelInfo" data-hotelid="@Model.HotelID" data-sr="@encSupplierCode" href="javascript:;"><div class="h2_mhdb2_heading2"></div></a>
                        </div>
                        <div class="clear"></div>
                        <div class="s3_hinfo_lgra">@string.Join(" ", addressList)</div>
                        <div class="h2_mhdb2_mapbox">@Model.LocationDescription, @Model.HotelCity <span class="add-cursor-pointer ShowMap" data-name="@Model.HotelName" data-city="@Model.HotelCity"><a style="color: #ec1c24 !important;">View Map</a></span></div>
                        @*<div style="color:#808080;margin:1em">No, 10 jalan Cendana, Off Jalan Sultan Ismail, 50250 Kuala Lumpur, Malaysia</div>
                            <div style="color:#808080;margin:1em">+60 3-2268 1188 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:red;padding-right:10px">View Map</span><img src="~/Images_hotel/location_icon.png" /></div>*@
                    </div>
                </div>
                <!-- left detail end -->

                <div class="clear"></div>
            </div>
            <div class="s3_hotel_topline lineblack"></div>
            <div class="s4_payment_heading">Contact Details</div>
            <div class="s3_hotel_contacts_box">
                <!-- PERSONAL DETAIL START -->
                @{
                    var contactPerson = Model.RoomPaxHotels.FirstOrDefault(x => x.IsContactPerson.HasValue && x.IsContactPerson.Value);
                    string phoneNum = Alphareds.Module.Common.UtilitiesService.GetPhoneCode(contactPerson.Phone1LocationCode) != "" ? "(" + Alphareds.Module.Common.UtilitiesService.GetPhoneCode(contactPerson.Phone1LocationCode) + ")" : "-";
                    string phoneNum2 = Alphareds.Module.Common.UtilitiesService.GetPhoneCode(contactPerson.Phone2LocationCode) != "" ? "(" + Alphareds.Module.Common.UtilitiesService.GetPhoneCode(contactPerson.Phone2LocationCode) + ")" : "-";
                }
                <div class="pd_containerbox">
                    <div class="pdcont_nameleft2">
                        @{  string fLetters = "";
                            foreach (var part in string.Join(" ", contactPerson.FullName).Split(' '))
                            {
                                if (part.Any(x => x != ' ' && fLetters.Length <= 2))
                                {
                                    fLetters += part.First();
                                }
                            }
                        }
                        <div class="mpjm_pd_heading_left mpjm_spclclass_mt" style="margin-top: 12px;">@fLetters.ToUpper()</div>
                        <div class="clear"></div>
                    </div>
                    <div class="pdcont_nameright">
                        <div class="s4_guest_tabs_name_container">
                            <h3>@contactPerson.TitleCode @contactPerson.GivenName.ToUpper() @contactPerson.Surname.ToUpper()</h3>
                            <div>Email: <span>@contactPerson.PassengerEmail</span></div>
                        </div>
                        <div class="mpjm_halfdiv">
                            <div class="mpjmhd_lable spcl_bigfont">Primary Phone Number</div>
                            <div class="mpjmhd_ans spcl_bigfont1">@phoneNum @contactPerson.Phone1</div>
                        </div>
                        <div class="mpjm_halfdiv">
                            <div class="mpjmhd_lable spcl_bigfont">Secondary Phone Number</div>
                            <div class="mpjmhd_ans spcl_bigfont1">@phoneNum2 @contactPerson.Phone2</div>
                        </div>

                        @if (Model.PromoID != 0)
                        {
                            Alphareds.Module.Model.PromoCodeFunctions promocodeFunc = new Alphareds.Module.Model.PromoCodeFunctions(Model.PromoID, db);

                            if (promocodeFunc.GetFrontendFunction.ForeignPurchase)
                            {
                                <div class="mpjm_halfdiv">
                                    <div class="mpjmhd_lable spcl_bigfont">Nationality</div>
                                    <div class="mpjmhd_ans spcl_bigfont1">@(!string.IsNullOrWhiteSpace(contactPerson.Nationality) &&
                                    contactPerson.Nationality != "NA" ? UtilitiesService.GetCountryName(contactPerson.Nationality) : "-")</div>
                                </div>
                                <div class="clear"></div>

                                <div class="mpjm_halfdiv">
                                    <div class="mpjmhd_lable spcl_bigfont">Passport Number</div>
                                    <div class="mpjmhd_ans spcl_bigfont1">@(string.IsNullOrWhiteSpace(contactPerson.Passport) ? "-" : contactPerson.Passport)</div>
                                </div>
                                <div class="mpjm_halfdiv">
                                    <div class="mpjmhd_lable spcl_bigfont">Passport Expiry Date</div>
                                    <div class="mpjmhd_ans spcl_bigfont1">@((contactPerson.PassportExpiryDate != null ? contactPerson.PassportExpiryDate.Value.ToString("dd MMM yyyy") : "-"))</div>
                                </div>
                                <div class="mpjm_halfdiv">
                                    <div class="mpjmhd_lable spcl_bigfont">Passport Issuing Country</div>
                                    <div class="mpjmhd_ans spcl_bigfont1">@(!string.IsNullOrWhiteSpace(contactPerson.PassportIssueCountryCode) ? UtilitiesService.GetCountryName(contactPerson.PassportIssueCountryCode) : "-")</div>
                                </div>
                                <div class="clear"></div>
                            }
                        }
                    </div>
                    <div class="clear"></div>
                </div>
                <!-- PERSONAL DETAIL END -->
            </div>

            <div class="s3_hotel_topline lineblack" style="margin-top: 2em;"></div>

            <div class="s4_payment_heading">Guest Details</div>

            <div style="margin-bottom: 60px;">
                <div class="payment_graytab_container mt20">
                    @{
                        var roomPaxWithOutContact = Model.RoomPaxHotels.Where(x => x.IsContactPerson.HasValue && !x.IsContactPerson.Value);
                        var grpRoom = roomPaxWithOutContact.GroupBy(x => new { x.RoomTypeDescription, x.ItineraryNumber });
                        var customizedfield = Model.User.Organization.CustomizedFields.FirstOrDefault() ?? new Alphareds.Module.Model.Database.CustomizedField();
                        int counter = 1;
                    }
                    @foreach (var room in grpRoom.OrderByDescending(x => x.Count()))
                    {
                        <!-- row start -->
                        <div class="pasengerTypeInfo">


                            <div class="payment_gray_tabs">
                                <div class="pgt_left">
                                    @(room.Key.RoomTypeDescription)x @room.Count()
                                    <div class="pgt_right">Itinerary#@room.Key.ItineraryNumber &nbsp;</div>
                                </div>
                                <div class="clear"></div>
                            </div>
                            @foreach (var roomDetail in room)
                            {
                                fLetters = "";
                                foreach (var part in roomDetail.FullName.Split(' '))
                                {
                                    if (part.Any(x => x != ' ' && fLetters.Length <= 2))
                                    {
                                        fLetters += part.First();
                                    }
                                }

                                string freeCancelPolicyText = "";
                                var detailCancelPolicy = "";
                                bool eligibleForRefund = roomDetail.NonRefundable.HasValue && roomDetail.NonRefundable.Value;
                                var earliestCancel = roomDetail.RoomPaxCancelPolicies != null ? roomDetail.RoomPaxCancelPolicies.OrderByDescending(x => x.NightCount).FirstOrDefault() : null;
                                if (earliestCancel != null && eligibleForRefund)
                                {
                                    int nightCount = earliestCancel.NightCount;
                                    DateTime minCancelDate = Model.CheckInDateTime.AddDays(nightCount);
                                    //freeCancelPolicyText = "Free cancellation before " + minCancelDate.ToString("dd MMM yyyy, ddd");
                                    // 2017/02/18 - KC request to hide free cancellation due to unsure condition return from Expedia Service
                                    freeCancelPolicyText = "Cancellation Policy";
                                    detailCancelPolicy = earliestCancel.RoomPaxHotel.CancellationPolicy;
                                    @*<div class="s3_hinfo_freecancelation" style="background-image: none; color: #ec1d27;">
                                            @roomDetail.CancellationPolicy
                                        </div>*@
                                }
                                @*else if (roomRateInfo != null && !roomRateInfo.nonRefundable)
                                    {
                                        int nightCount = -1;
                                        int.TryParse(earliestCancel.nightCount, out nightCount);
                                        DateTime minCancelDate = arrivalDate.AddDays(nightCount);
                                        <div class="s3_hinfo_freecancelation">
                                            Free cancellation before @minCancelDate.ToString("dd MMM yyyy, ddd") on<br />
                                            <span> @earliestCancel.cancelTime @earliestCancel.timeZoneDescription</span>
                                        </div>
                                    }*@

                                <div class="payment_fulldetail_container">
                                    <div class="s4_blue_top_pati">Room @counter <span class="policy pgt_right_detail add-cursor-pointer">@freeCancelPolicyText</span></div>
                                    <div id="cancelPolicyDtl" class="hidden">
                                        @Html.Raw(detailCancelPolicy)
                                    </div>
                                    <!-- PERSONAL DETAIL START -->
                                    <div class="pd_containerbox">
                                        <div class="pdcont_nameleft">
                                            <div class="mpjm_pd_heading_left mpjm_spclclass_mt">@fLetters.ToUpper()</div>
                                            @*<div class="clear"></div>*@

                                            <div class="pdcont_nameright">
                                                <div class="s4_guest_tabs_name_container">
                                                    <h3>@roomDetail.TitleCode @roomDetail.FullName.ToUpper()</h3>
                                                    <h4>Date of birth: <span>@(roomDetail.DOB.HasValue ? roomDetail.DOB.Value.ToString("dd MMM yyyy") : "-")</span></h4>
                                                </div>
                                                <div> Special Request (Subject To availability)</div>
                                                <div class="mpjm_halfdiv">
                                                    <div class="mpjmhd_lable spcl_bigfont">Smoking Room</div>
                                                    <div class="mpjmhd_ans spcl_bigfont1">@UtilitiesService.ConvertSmoking(@roomDetail.SmokingPreferences)</div>
                                                </div>
                                                @*<div class="mpjm_halfdiv">
                                                        <div class="mpjmhd_lable  spcl_bigfont">Floor Options</div>
                                                        <div class="mpjmhd_ans spcl_bigfont1">- (n/a)</div>
                                                    </div>*@
                                                <div class="mpjm_halfdiv">
                                                    <div class="mpjmhd_lable  spcl_bigfont">Additional Request</div>
                                                    <div class="mpjmhd_ans spcl_bigfont1">@(roomDetail.SpecialInformation ?? "-")</div>
                                                </div>

                                                @{
                                                    string bedDesc = "", imagePath = "";
                                                    string betXMLPath = System.Web.Hosting.HostingEnvironment.MapPath("~/App_Data/Hotel_BetTypes.xml");
                                                    //Twin - 2017/02/02 - Add checking on room special request for bed is null
                                                    var roomSpecialRequest = roomDetail.RoomPaxSpecialRequests.FirstOrDefault(x => x.SpecialRequestID == (int)Alphareds.Module.Common.Enumeration.SpecialRequestHotelType.Bed);
                                                    string ssrBetId = roomSpecialRequest != null ? roomSpecialRequest.SpecialRequestValue : null;
                                                    ExpediaHotelsServiceCall.GetImagesFromXML(betXMLPath, SearchImageColumn.ID, (ssrBetId ?? "-"), ref bedDesc, ref imagePath);

                                                    string checkInDesc = "";
                                                    checkInDesc = roomDetail.RoomPaxSpecialRequests.FirstOrDefault() != null ? roomDetail.RoomPaxSpecialRequests.FirstOrDefault(x => x.SpecialRequestID == (int)Alphareds.Module.Common.Enumeration.SpecialRequestHotelType.Checkin).SpecialRequestValue : null;
                                                }

                                                <div class="mpjm_halfdiv">
                                                    <div class="mpjmhd_lable spcl_bigfont">Bedding Request</div>
                                                    <div class="mpjmhd_ans spcl_bigfont1">@(string.IsNullOrEmpty(bedDesc) ? "-" : bedDesc)</div>
                                                </div>
                                                <div class="mpjm_halfdiv">
                                                    <div class="mpjmhd_lable spcl_bigfont">Check In</div>
                                                    <div class="mpjmhd_ans spcl_bigfont1">@(checkInDesc ?? "-")</div>
                                                </div>
                                                @if (customizedfield.CustomizedField1 != null)
                                                {
                                                    <div class="mpjm_halfdiv">
                                                        <div class="mpjmhd_lable spcl_bigfont">@customizedfield.CustomizedField1</div>
                                                        <div class="mpjmhd_ans spcl_bigfont1">@(roomDetail.CustomizedField1 ?? "-")</div>
                                                    </div>
                                                }
                                                @if (customizedfield.CustomizedField2 != null)
                                                {
                                                    <div class="mpjm_halfdiv">
                                                        <div class="mpjmhd_lable spcl_bigfont">@customizedfield.CustomizedField2</div>
                                                        <div class="mpjmhd_ans spcl_bigfont1">@(roomDetail.CustomizedField2 ?? "-")</div>
                                                    </div>
                                                }
                                                @if (customizedfield.CustomizedField3 != null)
                                                {
                                                    <div class="mpjm_halfdiv">
                                                        <div class="mpjmhd_lable spcl_bigfont">@customizedfield.CustomizedField3</div>
                                                        <div class="mpjmhd_ans spcl_bigfont1">@(roomDetail.CustomizedField3 ?? "-")</div>
                                                    </div>
                                                }
                                                @if (customizedfield.CustomizedField4 != null)
                                                {
                                                    <div class="mpjm_halfdiv">
                                                        <div class="mpjmhd_lable spcl_bigfont">@customizedfield.CustomizedField4</div>
                                                        <div class="mpjmhd_ans spcl_bigfont1">@(roomDetail.CustomizedField4 ?? "-")</div>
                                                    </div>
                                                }
                                                <div class="clear"></div>

                                            </div>
                                        </div>
                                        <div class="clear"></div>
                                    </div>
                                    <!-- PERSONAL DETAIL END -->
                                </div>
                                                        counter++;
                                                    }
                            <!-- row end -->
                        </div>
                                                    }
                </div>
            </div>

            <div class="s3_hotel_topline lineblack"></div>
            <div class="s4_blt_heading payment">Booking Summary</div>            
            <div class="s4_blt_py_container">
                @{
                    var grpRoom_Payment = roomPaxWithOutContact.GroupBy(x => new { x.RoomTypeDescription });
                    var bundle_Grp = roomPaxWithOutContact.Where(x => !string.IsNullOrWhiteSpace(x.RateDescription) &&
                    Model.SupplierCode == "TP"
                    ).GroupBy(x => new { x.RateDescription });
                }
                @foreach (var room in grpRoom_Payment)
                {
                    <div class="s4_blt_py_con_left">@(room.Key.RoomTypeDescription) x @room.Count()</div>
                    decimal roomTotalAmt = room.SelectMany(x => x.RoomPaxCharges).Where(q => q.ChargeCode == "BRATE" && q.IsDisplay).Sum(x => x.ChargeAmount) + roomPaxWithOutContact.SelectMany(x => x.RoomPaxCharges).Where(q => q.ChargeCode == "TAX" && q.IsDisplay).Sum(x => x.ChargeAmount) + Model.GSTAmt;
                    <div class="s4_blt_py_con_right">@Model.CurrencyCode<span> @roomTotalAmt.ToString("#,##0.00")</span></div>
                    <div class="clear"></div>
                }

                @if (Model.BundleID != 0 && bundle_Grp.Any())
                {
                    <div class="s4_blt_py_con_left">Bundled Items</div>
                    <div class="s4_blt_py_con_right"></div>
                    <div class="clear"></div>
                    <div class="bundles_item" style="margin-bottom: 20px;clear: both; color: #1C75BC">
                        @foreach (var item in bundle_Grp)
                        {
                            <div style="margin-left: 5%;">@item.Sum(x => x.QuotedOccupancy ?? 0) x @item.Key.RateDescription.Remove(0, item.Key.RateDescription.IndexOf('+') + 1)</div>
                            <div class="clear"></div>
                        }
                    </div>
                }
                else if (bundle_Grp != null && bundle_Grp.Any(x => x != null && x.Key != null && x.Key.RateDescription.Contains('+')))
                {
                    <div class="s4_blt_py_con_left">Bundled Items</div>
                    <div class="s4_blt_py_con_right"></div>
                    <div class="clear"></div>
                    <div class="bundles_item" style="margin-bottom: 20px;clear: both; color: #1C75BC">
                        @foreach (var item in bundle_Grp.Where(x => x.Key.RateDescription.Contains('+')))
                        {
                            <div style="margin-left: 5%;">@item.Sum(x => x.QuotedOccupancy ?? 0) x @item.Key.RateDescription.Remove(0, item.Key.RateDescription.IndexOf('+') + 1)</div>
                            <div class="clear"></div>
                        }
                    </div>
                }

                @try
                {
                    @Html.Partial("~/Views/Payment/SummaryPartials/_InsuranceDetails.cshtml", Model.SuperPNR.BookingInsurances)
                }
                catch
                {
                }

                @try
                {
                    @Html.Partial("~/Views/Payment/SummaryPartials/_EventDetails.cshtml", Model.SuperPNR.EventBookings)
                }
                catch
                {

                }

                @*<div class="s4_blt_py_con_left">Taxes &amp; Fees</div>
                    <div class="s4_blt_py_con_right">@Model.CurrencyCode<span> @(roomPaxWithOutContact.SelectMany(x => x.RoomPaxCharges).Where(q => q.ChargeCode == "TAX" && q.IsDisplay).Sum(x => x.ChargeAmount).ToString("#,##0.00"))</span></div>
                    <div class="clear"></div>*@

                <div class="s4_blt_py_con_left">Processing Fee</div>
                <div class="s4_blt_py_con_right">@Model.CurrencyCode<span> @(feeChargeHotel != null ? (feeChargeHotel.FeeChargeAmount + feeChargeHotel.TaxAmount).ToString("#,##0.00") : 0.ToString("#,##0.00"))</span></div>
                <div class="clear"></div>

                @*<div class="s4_blt_py_con_left">GST (SR @(taxRate.ToString("n0"))%)</div>
                    <div class="s4_blt_py_con_right">
                        @Model.CurrencyCode<span>
                            @((Model.GSTAmt + (feeChargeHotel != null ? feeChargeHotel.TaxAmount : 0)).ToString("#,##0.00"))
                        </span>
                    </div>
                    <div class="clear">
                    </div>*@

                <div class="s4_total_price"></div>
                <div class="s4_blt_py_con_left">Total Amount Paid</div>
                <div class="s4_blt_py_con_right">@Model.CurrencyCode<span> @((Model.SuperPNR.SuperPNROrders.Sum(s => s.TotalBookingAmt + s.FeeChargeOrders.Sum(a => a.FeeChargeAmount + a.TaxAmount))).ToString("#,##0.00"))</span></div>
                <div class="clear"></div>
            </div>
            <div class="s4_blt_heading payment">Payment Method</div>
            <div class="s4_blt_py_container">
                @Html.Partial("~/Views/Payment/SummaryPartials/_PaidInformation.cshtml", Model.SuperPNR)

                @if (Model.PromoID != 0)
                {
                    var promoCodeRule = Model.PromoCodeRule;
                    bool isAutoApplied = promoCodeRule.PromoFunctions.Any(x => x.FrontendFunction.FrontEndID == (int)Alphareds.Module.Model.FrontendFunction.Enum.FrontendFunction.PackageAutoApplied || x.FrontendFunction.FrontEndID == (int)Alphareds.Module.Model.FrontendFunction.Enum.FrontendFunction.HotelAutoApplied);
                    string displaypromoname = string.IsNullOrWhiteSpace(promoCodeRule.DisplayPromoName) ? null : $" - {promoCodeRule.DisplayPromoName}";
                    string displaypromocode = $"Promo Code {(!isAutoApplied ? $"({promoCodeRule.PromoCode}{displaypromoname})" : "")}";

                    <div class="s4_blt_py_con_left">
                        @displaypromocode
                    </div>
                    <div class="s4_blt_py_con_right">@Model.CurrencyCode<span>@Model.DiscountAmt.ToString("#,##0.00")</span></div>
                    <div class="clear"></div>
                }
            </div>

            <!-- FLIGHT DETAILS END -->
        </div>

        @if (bkStatus == "CON")
        {
            <!-- ipay portion start -->
            <div class="ipay_container">
                <div class="s5_payin_left">
                    <div class="s5_pl_text">Forward this confirmation to:</div>
                    <div><input name="emails" id="emails" type="text" class="s5_pl_textbox" placeholder="Email Address" onfocus="this.placeholder = ''" onblur="this.placeholder = 'Email Address'"></div>
                    <div id="emailrequiredmsg" class="field_error_msg"></div>
                    <div class="s5_pl_text1">Separate using ";" to send to multiple email addresses</div>
                    <button type="button" class="s5_pl_button add-cursor-pointer" value="Send" onclick=javascript:checkEmails();>Send</button>

                    @using (Html.BeginForm("printBookingItinerary", "Checkout", FormMethod.Post, new { @id = "printForm", @target = "_blank" }))
                    {
                        @Html.HiddenFor(x => x.SuperPNRNo);
                        @Html.HiddenFor(x => x.BookingID);
                        <div class="ipay_paynow_button1"><button id="print" class="s5_pl_button add-cursor-pointer">Print</button></div>
                    }
                </div>

                <div class="clear"></div>
            </div>
            <!-- ipay portion end -->
        }

    </div>
</div>
<!-- MAIN CONTENT PORTION END -->
@Html.Partial("~/Views/Hotel/_GoogleMap.cshtml")
@Html.Partial("~/Views/Shared/MasterThemes/_PopOutModal.cshtml")
@Html.Partial("~/Views/Shared/MasterThemes/_LoadingModal.cshtml")
@Html.Partial("~/Views/Booking/_SendEmailMessage.cshtml")

@section scripts{
    @Html.Partial("~/Views/Hotel/_SharedJSScripts.cshtml")
    @Html.Partial("~/Views/Hotel/_PopoutHotelFunctionJSScripts.cshtml")

    <script language="javascript">
        $('.policy.pgt_right_detail').click(function () {
            $('#modal-container').css('text-align', 'justify');
            $('#modal-container').css('font-family', '"UbuntuRegular"');
            $('#modal-container').append('<div style="margin-bottom: 1em;color: #EC1C24;font-size: 20px;">Booking Cancellation Policy</div>');
            $('#modal-container').append($('#cancelPolicyDtl').html());
            $("#popup-modal").show();
        });

        $("#emails").change(function () {
            if ($("#emails").val() != "") {
                var div = document.getElementById('emailrequiredmsg');
                div.innerHTML = '';
            }
        });
        function checkEmail(email) {
            var regExp = /^(?=.{5,50}$)(?=^[a-zA-Z0-9])(?=.*[a-zA-Z0-9]$)([a-zA-Z0-9_\-\.]{1,44})[a-zA-Z0-9]@@(?=(?:[^.]*\.){1,2}[^.]*$)[a-zA-Z0-9]([a-zA-Z0-9-\.]{4,47})$/;
            return regExp.test(email);
        }
        function checkEmails() {
            var emails = document.getElementById("emails").value;
            var invEmails = "";
            var msg = "";
            if ($('#emails').val().search(';') < 0) {
                var emailArray = emails;
                if (checkEmail(emailArray)) {
                    //...
                } else {
                    if (emailArray == "") {
                        var div = document.getElementById('emailrequiredmsg');
                        div.innerHTML = 'This is required field';
                    } else if (emailArray.match(/^(?=.{5,50}$)/) != "") {
                        msg = "Maximum length of email is 50 characters";
                        invEmails += msg + ":\n" + emailArray + "\n";
                    } else {
                        invEmails += "Invalid emails:\n" + emailArray + "\n";
                    }
                }
            } else {
                var emailArray = emails.split(/[\s;]+/);
                for (i = 0; i < (emailArray.length) ; i++) {
                    if (checkEmail(emailArray[i])) {
                        //...
                    } else {
                        if (emailArray[i].match(/^(?=.{5,50}$)/) != "") {
                            msg = "Maximum length of email is 50 characters";
                            invEmails += msg + ":\n" + emailArray[i] + "\n";
                        } else {
                            invEmails += "Invalid emails:\n" + emailArray[i] + "\n";
                        }
                    }
                }
            }
            if (emails == "") {
                //...
            } else if (invEmails != "") {
                alert(invEmails);
                //jQuery.noConflict();
                //$('#bookId').html("invalid email entered:<br> " + invEmails);
                //$('#myModal').modal('show');
            } else {
                sendEmails(emailArray, false);
            }
        }
        //Send email - START
        function sendEmails(emailArray, isBookingPerson) {
            var SuperPNRID = '@Model.SuperPNRID';

            ajaxSendMail(emailArray, SuperPNRID, isBookingPerson);
        }

        function ajaxSendMail(emailArray, SuperPNRID, isBookingPerson) {
            $.ajax({
                type: "POST",
                cache: false,
                url: '/Checkout/SendBookingItineraryEmail',
                async: true,
                beforeSend: function () { $('#loading-modal').show(); },
                data: { emailArray: emailArray, isBookingPerson: isBookingPerson, SuperPNRID: SuperPNRID },
            }).done(function (res) {
                $('#loading-modal').hide();
                if (res == 'True' && !isBookingPerson) {
                    $('#sendEmailSuccess').show();
                } else if (res == 'False' && !isBookingPerson) {
                    $('#sendEmailFailed').show();
                }
            });
        }
        //Send email - END

        //Print Booking Itinerary - START
        $('#print').click(function (event) {
            $('#printForm').submit();
        });
        //Print Booking Itinerary - END
    </script>

    @if (bkStatus == "CON" || bkStatus == "RHI")
    {
        <script>
            $(document).ready(function () {
                trackTransaction('@Model.SuperPNRNo', '@Model.TotalBookingAmt.ToString("0.00")', '@Model.GSTAmt.ToString("0.00")');
            });
        </script>
    }
}
